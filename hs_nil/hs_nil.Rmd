```{r}

library(tidyverse)
library(ggalt)
library(ggplot2)
library(readr)
library(usmap)
library(maps)
library(dplyr)

```

Load in the binary answer file.

```{r}

hs_nil <- read_csv("https://raw.githubusercontent.com/pabs-s/jour479x_fall_2024/refs/heads/main/hs_nil/nil_clean.csv")
hs_nil
```

Categories included so far are: 
- State Policy: Y/N
- Year Enacted:
- Did we get a response from an admin?: Y/N
- Parent or guardian permission required for entering a deal?: Y/N
- Are boosters or collectives permitted?: Y/N
- Requirement to notify school officials?: Y/N
- Is there an applicable state law?: Y/N
- Are there category restrictions?: Y/N

Points of clarification for us to work through together as a class:
- Our question about usage of school logos, names or uniforms: Are there instances where a policy specifies that athletes can use two of the three or are all three typically grouped together?
School property, school-sanctioned events

- Is there a discrepancy between a policy's enacted date versus the date it went into effect? Which do we prefer as a class?


- Prohibited Categories: How can we better group some of our categories for visualization? Does it make sense to create a "super category" for tobacco, nicotine, vaping and regulated/controlled substances? How can we also group illegal substances or gaming and gambling?
- Groupings ready for viz next week.

- NIL Payments: Can we identify whether schools are tracking individual payments or total payments over a period of time? Are there compensation limits in either of those instances (i.e., can only earn X dollars over one school year vs X dollars in one payment). Which do these policies focus on, if specified?
- Focus timing for the reporting of these deals, not so much the payment values

- NIL Violations and Accountability: Is there an abdication of adult/school responsibility in states where no parental guidance or school notice is required? Who is held accountable in those cases?  
Highlight Alaska, but also any other states that have a three-strike model. South Carolina has a three-strike policy for athletes.

- Officiating athletic contests is a potential unique reporting line: Is Kansas the only state to make reference of student-athletes being permitted to be compensated as referees, but not as coaches? Why make that distinction in the first place? What's the state's policy on appearances for NIL and would these not fall under that? 


Regarding all of these points and of the visualizations below: How are we going to describe this when we go to write it? If we were to write a paragraph about this question, what would it look like?

------------
Map visualization of state policies

```{r}

us_map <- map_data("state")

nil_states <- hs_nil |>
  mutate(state = tolower(state))

us_map_data <- us_map("states") |>
  mutate(full = tolower(full))  

nil_usmap_data <- us_map_data |>
  left_join(nil_states, by = c("full" = "state"))

nil_usmap_data <- nil_usmap_data |>
  mutate(state_policy = case_when(
    full == "north carolina" ~ "Y",
    full == "ohio" ~ "N",
    full == "indiana" ~ "N",
    full == "tennessee" ~ "Y",
    full == "utah" ~ "Y",
    full == "vermont" ~ "Y",
    TRUE ~ state_policy 
  ))


```

```{r}

plot_usmap(data = nil_usmap_data, values = "state_policy", regions = "states") +
  scale_fill_manual(values = c("Y" = "blue", "N" = "red", "Limited" = "yellow"),
                    labels = c("Y" = "Yes", "N" = "No", "Limited" = "Limited")) +
  labs(title = "NIL Policy Status by U.S. State", fill = "Policy Status") +
  theme(panel.background = element_blank())

```
Notes:

----------------
Map of the South Region Based on NIL Policy Adoption.

```{r}

plot_usmap(data = nil_usmap_data, values = "state_policy", include = .south_region, exclude = c("VA", "WV", "MD", "DE", "DC", "KY"), regions = "states", labels = TRUE) +
  scale_fill_manual(
    values = c("Y" = "blue", "N" = "red", "Limited" = "yellow"),
    labels = c("Y" = "Yes", "N" = "No", "Limited" = "Limited")
  ) +
  labs(title = "The South Lags in HS NIL Policy Adoption", fill = "Policy Status") +
  theme(panel.background = element_blank())

```

What does this show us? Why might there be such a high concentration of states in this region that have declined to enact an NIL policy for high schoolers? Also, can we figure out approximately how many high school athletes live in this region that are impacted by these decisions?

Notes: (Fixed)

---------------
Years enacted: 

```{r}

yearly_enactments <- nil_states |>
  filter(!is.na(year_enacted)) |>
  group_by(year_enacted) |>
  summarise(count = n())

```

```{r}

max_count <- max(yearly_enactments$count, na.rm = TRUE)

ggplot(yearly_enactments, aes(x = factor(year_enacted), y = count)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Number of States Enacting NIL Policies by Year",
       x = "Year Enacted",
       y = "Number of States") +
  scale_y_continuous(breaks = seq(0, max_count, by = 1)) +  
  theme_minimal()

```
Looking at these results, let's see what we can find out about that jump in 2022. Which states set the tone in 2021 and what do we think was the catalyst in 2022?
Notes:


```{r}
nil_usmap_data <- nil_usmap_data |>
  mutate(
    year_enacted = as.character(year_enacted),
    year_enacted_override = ifelse(full == "north carolina", "2024", year_enacted)  # Overrides North Carolina to match the "2024" color
  )

# Define colors without a separate "NC" entry
year_colors <- c("2021" = "yellow", "2022" = "darkgreen", "2023" = "purple", "2024" = "blue", "No NIL" = "grey")

# Plot the map with customized color for North Carolina
plot_usmap(data = nil_usmap_data, values = "year_enacted_override", regions = "states") +
  scale_fill_manual(
    name = "Year Enacted", 
    values = year_colors,
    na.translate = FALSE 
  ) +
  labs(
    title = "NIL Policy Adoption by Year", 
    fill = "Year Enacted", 
    subtitle = "Preliminary visualization"
  ) +
  theme(panel.background = element_blank())

```

Notes:

Proposed but denied is a potential graphic.


-----------------------
Admin response: These states played ball. 

```{r}

nil_usmap_data <- nil_usmap_data |>
  mutate(
    employee_response = ifelse(full == "north carolina", "NC", employee_response)
  )

plot_usmap(data = nil_usmap_data, values = "employee_response", regions = "states") +
  scale_fill_manual(
    values = c("Y" = "blue", "N" = "red"),  
    na.value = "lightgray"
  ) +
  labs(
    title = "These States Played Ball", 
    subtitle = "Visual distribution of states that provided a policy response to our reporters.", 
    fill = "Employee Response"
  ) +
  theme(panel.background = element_blank()) +
  
  geom_sf(data = subset(nil_usmap_data, full == "north carolina"), fill = "blue", color = NA, show.legend = FALSE)

```
Notes:

New Mexico -- response received, but didn't "feel comfortable" answering questions. (Fixed)

------------------------
Parent/Guardian Involvement and School Notification:

```{r}

pg_sn <- nil_usmap_data |>
  mutate(
    parent_notification_combo = case_when(
      parent_guardian == "Y" & notification == "Y" ~ "Y_Y",
      parent_guardian == "Y" & notification == "N" ~ "Y_N",
      parent_guardian == "N" & notification == "Y" ~ "N_Y",
      parent_guardian == "N" & notification == "N" ~ "N_N",
      parent_guardian == "No NIL" ~ "No NIL",   
      TRUE ~ NA_character_  
    )
  )

combo_colors <- c("Y_Y" = "blue", "Y_N" = "purple", "N_Y" = "yellow", "N_N" = "red", "No NIL" = "cyan")

```

```{r}

pg_sn <- nil_usmap_data |>
  mutate(
    parent_notification_combo = case_when(
      parent_guardian == "Y" & notification == "Y" ~ "Y_Y",
      parent_guardian == "Y" & notification == "N" ~ "Y_N",
      parent_guardian == "N" & notification == "Y" ~ "N_Y",
      parent_guardian == "N" & notification == "N" ~ "N_N",
      parent_guardian == "No NIL" ~ "No NIL",   
      TRUE ~ "Not Specified"   
    ),
    parent_notification_combo = addNA(parent_notification_combo)  
  )

combo_colors <- c("Y_Y" = "blue", "Y_N" = "purple", "N_Y" = "yellow", "N_N" = "red", "No NIL" = "cyan", "Not Specified" = "lightgray")
```

```{r}

plot_usmap(data = pg_sn, values = "parent_notification_combo", regions = "states") +
  scale_fill_manual(
    name = "Requirement",
    values = combo_colors,
    labels = c(
      "Y_Y" = "Parent/Guardian and School Notif. Required",
      "Y_N" = "Parent/Guardian Required Only",
      "N_Y" = "School Notif. Required Only",
      "N_N" = "Neither Required",
      "No NIL" = "No NIL",
      "NA" = "Not Specified" 
    )
  ) +
  labs(
    title = "Parent/Guardian and School Notification Requirements for NIL Policies", 
    fill = "Requirement"
  ) +
  theme(
    panel.background = element_blank(),
    legend.position = "left",               
    legend.justification = "center",       
    plot.margin = margin(10, 10, 10, 30),   
    plot.title.position = "plot",          
    plot.title = element_text(hjust = 0)   
  )

```

Notes:
Specify which states don't have NIL in the legend. (Fixed)

------------------------
What else do we want to see? What direction do we want to take with our reporting? What changes can we make to the Google Form to continue refining this data?

-------------------------------------------------------
Updates for 11/11/24 Class:

Feedback from the students on the previous visualizations has been implemented.

- Reporting Ideas: 
1. Three-Strike States: Pennsylvania (2022), South Carolina (2024), Florida (2024)
What can we identify regarding the differences between these policies? What prompted them to institute a three-strike policy? Why are they the only three to implement a policy like this? What did the more recent policies adopt from Pennsylvania's policy?

2. Limited Approval States: Mississippi (2024), Missouri (2023), Arkansas (2023), Nevada (2022)
Mississippi allows it for students committed to any collegiate institution, Missouri and Arkansas allow it for students committed to in-state collegiate institutions and Nevada only allows it for unsanctioned sports.

3. NFTs? Vermont, Maryland and Massachusetts all specifically cite NFTs as a permitted NIL category. 
Are high schoolers taking them up on that? Why bother explicitly including such a niche category? 


What I'm working on right now: Creating separate data frames for violations and prohibited NIL categories. I've created a data frame for approved NIL categories and will begin visualizing that.

Visualizations:

Map of US States filled in based on the number of prohibited categories
Stacked bar chart distribution of prohibited categories


```{r}
perm_cat <- read_csv("https://raw.githubusercontent.com/pabs-s/jour479x_fall_2024/refs/heads/main/hs_nil/nil_permitted_categories.csv")
```
















